<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

  <title>GreenFair</title>

  <!--    Google Fonts-->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800" rel="stylesheet"
    type="../text/css" />

  <!--Fontawesom-->
  <link rel="stylesheet" href="../css/font-awesome.min.css" />

  <!--Animated CSS-->
  <link rel="stylesheet" type="../text/css" href="../css/animate.min.css" />

  <!-- Bootstrap -->
  <link href="../css/bootstrap.min.css" rel="stylesheet" />
  <!--Bootstrap Carousel-->
  <link type="../text/css" rel="stylesheet" href="../css/carousel.css" />

  <link rel="stylesheet" href="../css/isotope/style.css" />

  <!--Main Stylesheet-->
  <link href="../css/style.css" rel="stylesheet" />
  <!--Responsive Framework-->
  <link href="../css/responsive.css" rel="stylesheet" />

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  <script src="../js/jquery-1.12.3.min.js"></script>
  <script src="../js/includeHTML.js"></script>

  <!-- localStorage Test -->
  <script>
    var output = localStorage.getItem("id");

    var arr = JSON.parse(output);

    console.log(arr); // [1,2,3,4,5]
  </script>

  <style>
    .recipe-card {
      border: 1px solid #d1d3d1;
      border-radius: 6px;
      width: 29%;
      height: 30%;
      margin: 0 20px 20px 10px;
      float: left;
    }

    .btn-storage {
      border: 1px solid #ffd518;
      background-color: #ffd518;
      display: block;
      overflow: hidden;
      width: 50%;
      height: 30px;
      font-size: 13px;
      float: left;
      position: relative;
      bottom: 0px;

    }
  </style>


</head>

<body>
  <script>
    // storage 뿌려주기
    var wish_recipes_id = [];
    var showRecipes = function () {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "http://127.0.0.1:5502/data/user_detail_ex.json");
      // xhr.setRequestHeader('Authorization', 'jwt '+localStorage.getItem('token'));
      xhr.send();
      xhr.onreadystatechange = function () {
        if (xhr.readyState !== XMLHttpRequest.DONE) {
          return;
        }

        if (xhr.status === 200) {
          responseObject = JSON.parse(xhr.responseText);
          responseObject.forEach((element) => {
            var wish_recipes_size = element.wish_recipes.length;
            console.log("length", wish_recipes_size);
            for (var i = 0; i < wish_recipes_size; i++) {
              wish_recipes_id.push(element.wish_recipes[i].reci_id);
            }
          });
        } else {
          console.log("error!");
        }

        console.log("arr", wish_recipes_id);
        $.each(wish_recipes_id, function (index, recipeNumber) {
          var xhr2 = new XMLHttpRequest();
          var url = 'https://save-your-ingredient.s3.amazonaws.com/recipes/' + recipeNumber + '.json';
          xhr2.open('GET', url);
          xhr2.send();

          xhr2.onreadystatechange = function () {
            if (xhr2.readyState === XMLHttpRequest.DONE) {
              if (xhr2.status === 200) {
                let loadedJSON = JSON.parse(xhr2.responseText);
                var html = "";
                html += '<li> \
                        <div class="blog_news" > \
                          <div class="recipe-card" > \
                            <div class="blog_img"> \
                              <a href="detail_recipe.html""><img src="' + loadedJSON.thumbnail + '" alt=""/></a> \
                            </div> \
                            <div class="blog_content" style="text-align: left;"> \
                                <a href="detail_recipe.html""><h3 id="plz">' + loadedJSON.name + '</h3></a> \
                            </div> \
                            <button id="'+ loadedJSON.id + '" class="btn-storage" style="border-bottom-left-radius: 6px; border-right-color: #d1d3d1;" onclick=completeBtn(this.id)>완료</button> \
                            <button id="'+ loadedJSON.id + '" class="btn-storage" style="border-bottom-right-radius: 6px;" onclick=deleteBtn(this.id)>삭제</button> \
                          </div> \
                        </div> \
                      </li>';

                $("#stored_recipe").append(html);
              } else {
                console.log("ERROR");
              }
            }
          }
        });
      }
    }

    showRecipes();
  </script>
  <script>
    // 창고 전체 삭제
    $(document).ready(function () {
      $('#deleteAllRecipe').click(function () {
        console.log('button clicked');
        localStorage.removeItem('recipeId');
        recipes = [];
        localStorage.setItem("recipeId", JSON.stringify(recipes));
        $('#stored_recipe').empty();
        card("recipeId", "#stored_recipe");
      });
    });
  </script>
  <script>
    // 레시피 완료 
    // TODO : 완료 클릭시 사라지게 
    function completeBtn(that) {
      // 완료한 것들 completeRecipeId로 localStorage에 저장
      if (localStorage.getItem('completeRecipeId') === null) {
        var completeRecipes = [];
      } else {
        var output = localStorage.getItem("completeRecipeId");
        var completeRecipes = JSON.parse(output);
      }


      console.log(that);
      if (completeRecipes.includes(that)) {
        deleteBtn(that);
        return;
      } else {
        completeRecipes.push(that);
      }
      localStorage.setItem("completeRecipeId", JSON.stringify(completeRecipes));

      // 완료한 것들 창고에서 삭제
      deleteBtn(that);
    }

    // 창고에서 삭제
    function deleteBtn(that) {
      // that : this.id
      console.log("delete come in");
      var output = localStorage.getItem("recipeId");
      var recipes = JSON.parse(output);
      console.log("before ", recipes);

      const idx = recipes.indexOf(that);
      if (idx > -1) {
        recipes.splice(idx, 1);

      }
      console.log("after ", recipes);
      localStorage.setItem("recipeId", JSON.stringify(recipes));
      $('#stored_recipe').empty();
      card("recipeId", "#stored_recipe");
    }
  </script>

  <nav class="include" include-html="./nav.html"></nav>

  <!-- storage.html 페이지 -->
  <section id="blog" style="padding: 20px;">
    <div class="container">
      <div class="row">
        <div class="col-md-8">
          <div class="latest_blog text-left">
            <img src="../img/recipe_chango.png">
            <button class="more-button" style="float: right;" id="deleteAllRecipe">창고 삭제</button>
            <hr />
          </div>
        </div>

        <div class="col-md-4">
          <div class="latest_blog text-left">
            <h3 style="padding-left: 10px">이거 필요해?</h3>
            <hr />
          </div>
        </div>
      </div>
      <!--End of row-->
      <div class="row">
        <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
          <ul id="stored_recipe">

            <script>

              var filteredArr = new Array;
              // 내 냉장고 재료 아이디 배열 가져오는 부분
              var refxhr = new XMLHttpRequest();
              refxhr.open("GET", "http://127.0.0.1:8000/stock/");

              refxhr.setRequestHeader('Authorization', 'jwt ' + localStorage.getItem('token'));

              refxhr.send();
              //재료 배열
              var myStockArr = new Array;
              refxhr.onreadystatechange = function () {
                if (refxhr.readyState !== XMLHttpRequest.DONE) return;
                if (refxhr.status === 200) {
                  console.log("success");
                  responseObject = JSON.parse(refxhr.responseText);
                  // console.log("<<", responseObject);
                  i = 0;
                  responseObject.forEach((user_rec) => {
                    myStockArr[i] = user_rec.ingredient_id;
                    i++;
                  });
                };
              };
              var reIngreArr = new Array;
              var card = function (localStorage_recipe, selector) {
                console.log("come in");
                var output = localStorage.getItem(localStorage_recipe);
                var recipes = JSON.parse(output);
                $.each(recipes, function (index, recipeNumber) {
                  var xhr = new XMLHttpRequest();
                  var url = 'https://save-your-ingredient.s3.amazonaws.com/recipes/' + recipeNumber + '.json';
                  // console.log("url::", url);
                  xhr.open('GET', url);
                  xhr.send();

                  xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                      if (xhr.status === 200) {
                        let loadedJSON = JSON.parse(xhr.responseText);
                        // console.log(loadedJSON);
                        var html = '<li> \
                                    <div class="blog_news" > \
                                      <div class="recipe-card"> \
                                        <div class="blog_img"> \
                                            <img src="' + loadedJSON.thumbnail + '" alt="" /> \
                                        </div> \
                                        <div class="blog_content" style="text-align: left;"> \
                                          <a href=""><h3>' + loadedJSON.name + '</h3></a> \
                                          <div class="expert"> \
                                            <div class="left-side text-left"> \
                                                <p class="left_side"> \
                                                <span class="clock"><i class="fa fa-clock-o"></i></span> \
                                                <span class="time">' + loadedJSON.time + '</span> \
                                                </p> \
                                            </div> \
                                          </div> \
                                        </div> \
                                        <button id="'+ loadedJSON.id + '" class="btn-storage" style="border-bottom-left-radius: 6px; border-right-color: #d1d3d1;" onclick=completeBtn(this.id)>완료</button> \
                                        <button id="'+ loadedJSON.id + '" class="btn-storage" style="border-bottom-right-radius: 6px;" onclick=deleteBtn(this.id)>삭제</button> \
                                      </div> \
                                    </div> \
                              </li>';
                        $(selector).append(html);
                        var temp = new Array;
                        temp = loadedJSON.ingredient_ids;
                        reIngreArr = $.merge(reIngreArr, temp);
                        reIngreArr = Array.from(new Set(reIngreArr));
                        // console.log(reIngreArr);

                        filteredArr = reIngreArr.filter((word) => !myStockArr.includes(word));

                        let newContent = '';
                        filteredArr.forEach((filteredArr) => {
                          newContent += `<div class="orderlist_board">
                                    <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                                      <a href="${filteredArr.link}"><h4>${filteredArr}</h4></a>
                                    </div>
                                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                                      <a href="${filteredArr.link}"><h4>주문하기</h4></a>
                                    </div>
                                  </div>`;
                        });

                        document.getElementById("orderlist").innerHTML = newContent;

                      } else {
                        console.log("error");
                      }
                    }
                  }
                });
              }
              console.log(filteredArr);
            </script>
          </ul>
        </div>


        <!-- 재료 주문 리스트 -->
        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4" id="orderlist"></div>
      </div>
      <!--End of container-->
  </section>

  <footer class="include" include-html="./footer.html"></footer>

  <script src="../js/jquery-1.12.3.min.js"></script>
  <script type="text/javascript" src="../js/list.js"></script>
  <script src="../js/includeHTML.js"></script>
  <script src="../js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
  <script>includeHTML();</script>
  <!--삭제-->
  <script type="text/javascript">
    $("#delbtn").click(function () {
      $("div").remove("#rm");
    });
  </script>

  <script>
    $("#amount option:selected").val();
  </script>

  <!--추가-->
  <script>
    $("#addbtn").click(function (event) {
      event.preventDefault();
      this.blur();

      $.popup({
        url: "./modal1.html",
        close: function (result) {
          console.log(result);
        },
      });
    });
  </script>

  <script>
    // 이 코드 뭔지..
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "http://127.0.0.1:8000/stock/");

    xhr.setRequestHeader('Authorization', 'jwt ' + localStorage.getItem('token'));

    xhr.send();

    xhr.onreadystatechange = function () {
      if (xhr.readyState !== XMLHttpRequest.DONE) return;
      if (xhr.status === 200) {
        responseObject = JSON.parse(xhr.responseText);

        let newContent = '';
        responseObject.forEach((user_rec) => {
          newContent += `<div class="orderlist_board">
                    <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
                      <a href="#"><h4>${user_rec.id}</h4></a>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4">
                      <a href="${user_rec.link}"><h4>주문하기</h4></a>
                    </div>
                  </div>`;
        });

        document.getElementById("orderlist").innerHTML = newContent;
      } else {
        console.log(`[${xhr.status}] : ${xhr.statusText}`);
      }
    };




    // var rexhr = new XMLHttpRequest();
    // rexhr.open("GET", "http://127.0.0.1:8000/stock/");

    // rexhr.setRequestHeader('Authorization', 'jwt ' + localStorage.getItem('token'));

    // rexhr.send();
    // var myStockArr= new Array;
    // rexhr.onreadystatechange = function () {
    //   if (rexhr.readyState !== XMLHttpRequest.DONE) return;
    //   if (rexhr.status === 200) {
    //     console.log("success");
    //     responseObject = JSON.parse(rexhr.responseText);
    //     console.log("<<", responseObject);


  </script>


</body>

</html>